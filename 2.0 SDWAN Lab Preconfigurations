
SDWAN Appliances
User: admin
Pass: pass

@cmd
route add 10.69.255.13 mask 255.255.255.255 10.69.255.5

**************
PRECONFIGS
**************

!@Cloud
conf t
 hostname CLOUD
 enable secret pass
 service password-encryption
 no ip domain lookup
 no logging cons
 banner motd '

Secret: pass

'
 vlan 10
  name RIVAN_SDWAN
 vlan 20
  name RIVAN_VEDGE
 vlan 69
  name RIVAN_HQ
 int vlan 10
  ip add 172.16.10.6 255.255.255.248
  no shut
  description SDWAN_CONTROLLERS
 int vlan 20
  ip add 192.168.20.6 255.255.255.0
  no shut
  description SDWAN_VEDGES
 int vlan 69
  ip add 10.69.255.6 255.255.255.248
  no shut
  description RIVAN_HEADQUARTERS
 int g0/0
  no switchport
  ip add 10.69.255.14 255.255.255.252
  no shut
  description VMANAGE_MGMT_INT
 int range g0/1-3
  switchport mode access
  switchport access vlan 10
 int range g1/1-3
  switchport mode access
  switchport access vlan 20
 int range g2/0-1
  switchport mode access
  switchport access vlan 69
  exit
 ip routing
 end
wr

!@Cloud (BGP Config)
conf t
 int lo8
  ip add 8.8.8.8 255.255.255.255
 router bgp 1
  bgp log-neighbor-changes
  neighbor 192.168.20.1 remote-as 100
  neighbor 192.168.20.5 remote-as 100
  neighbor 192.168.20.9 remote-as 100
  address-family ipv4
   neighbor 192.168.20.1 activate
   neighbor 192.168.20.5 activate
   neighbor 192.168.20.9 activate
   neighbor 192.168.20.1 as-override
   neighbor 192.168.20.5 as-override
   neighbor 192.168.20.9 as-override
   network 8.8.8.8 mask 255.255.255.255
   network 192.168.20.0 mask 255.255.255.0
   network 172.16.10.0 mask 255.255.255.248
   network 10.69.255.0 mask 255.255.255.248
   end



SDWAN APPLIANCES
(Case Sensitive) ORGANIZATION = RIVANCORP

!@vManage
conf t
 system
  host-name Rivan-vManage
  site-id 10
  system-ip 10.1.10.2
  organization-name RIVANCORP
  vbond 172.16.10.3
  admin-tech-on-failure
 vpn 0
  int eth0
   ip add 172.16.10.2/29
   no shut
   tunnel-interface
    allow-service all
  ip route 0.0.0.0/0 172.16.10.6
 vpn 512
  int eth1
   ip add 10.69.255.13/30
   no shut
  ip route 0.0.0.0/0 10.69.255.14
  commit
  end


!@vBond
conf t
 system
  host-name Rivan-vBond
  site-id 10
  system-ip 10.1.10.3
  organization-name RIVANCORP
  vbond 172.16.10.3 local vbond
  admin-tech-on-failure
 vpn 0
  int ge0/0
   ip add 172.16.10.3/29
   no shut
   tunnel-interface
    encapsulation ipsec
    allow-service all
  ip route 0.0.0.0/0 172.16.10.6
  commit
  end


!@vSmart
conf t
 system
  host-name Rivan-vSmart
  site-id 10
  system-ip 10.1.10.1
  organization-name RIVANCORP
  vbond 172.16.10.3
  admin-tech-on-failure
  vpn 0
   int eth0
    ip add 172.16.10.1/29
	no shut
	tunnel-interface
	 allow-service all
   ip route 0.0.0.0/0 172.16.10.6
   commit
   end
   
   
!@vEdge-LUZON
conf t
 system
  host-name vEdge-LUZON
  system-ip 10.1.21.1
  site-id 21
  organization-name RIVANCORP
  admin-tech-on-failure
  vbond 172.16.10.3
 vpn 0
  name "Transport VPN"
   router
    bgp 100
	 address-family ipv4-unicast
	  network 192.168.20.0/24
	  exit
	 neighbor 192.168.20.6 remote-as 1
	 exit
	exit
   exit
  int ge0/0
   description LAN-Traffic
   ip address 172.16.1.1/30
   tunnel-interface
    encapsulation ipsec
	color private1 restrict
    allow-service bgp
    no allow-service dhcp
    allow-service dns
    allow-service icmp
    no allow-service sshd
    no allow-service netconf
    no allow-service ntp
    allow-service ospf
    no allow-service stun
	no shut
	exit
  int ge0/1
   description INTERNET-Traffic
   ip add 192.168.20.1/24
   tunnel-interface
    encapsulation ipsec
    color biz-internet
    allow-service bgp
    no allow-service dhcp
    allow-service dns
    allow-service icmp
    no allow-service sshd
    no allow-service netconf
    no allow-service ntp
    no allow-service ospf
    no allow-service stun
	no shut
	exit
   exit
  vpn 512
   name "Management VPN"
   interface eth0
    description eth0
    ip dhcp-client
    no shutdown
	commit
    end
	 

!@vEdge-VISAYAS
conf t
 system
  host-name vEdge-VISAYAS
  system-ip 10.1.25.1
  site-id 25
  organization-name RIVANCORP
  admin-tech-on-failure
  vbond 172.16.10.3
 vpn 0
  name "Transport VPN"
   router
    no bgp 100
    bgp 100
	 address-family ipv4-unicast
	  network 192.168.20.0/24 
	  exit
	 neighbor 192.168.20.6 remote-as 1
	 exit
	exit
   exit
  int ge0/0
   description LAN-Traffic
   ip address 172.16.5.1/30
   tunnel-interface
    encapsulation ipsec
	color private1 restrict
    allow-service bgp
    no allow-service dhcp
    allow-service dns
    allow-service icmp
    no allow-service sshd
    no allow-service netconf
    no allow-service ntp
    allow-service ospf
    no allow-service stun
	no shut
	exit
  int ge0/1
   description INTERNET-Traffic
   ip add 192.168.20.5/30
   tunnel-interface
    encapsulation ipsec
    color biz-internet
    allow-service bgp
    no allow-service dhcp
    allow-service dns
    allow-service icmp
    no allow-service sshd
    no allow-service netconf
    no allow-service ntp
    no allow-service ospf
    no allow-service stun
	no shut
	exit
   exit
  vpn 512
   name "Management VPN"
   interface eth0
    description eth0
    ip dhcp-client
    no shutdown
	commit
    end


!@vEdge-MINDANAO (Optional)
conf t
 system
  host-name vEdge-MINDANAO
  system-ip 10.1.29.1
  site-id 29
  organization-name RIVANCORP
  admin-tech-on-failure
  vbond 172.16.10.3
 vpn 0
  name "Transport VPN"
   router
    no bgp 100
    bgp 100
	 address-family ipv4-unicast
	  network 192.168.20.0/24
	  exit
	 neighbor 192.168.20.6 remote-as 1
	 exit
	exit
   exit
  int ge0/0
   description LAN-Traffic
   ip address 172.16.9.1/30
   tunnel-interface
    encapsulation ipsec
	color private1 restrict
    allow-service bgp
    no allow-service dhcp
    allow-service dns
    allow-service icmp
    no allow-service sshd
    no allow-service netconf
    no allow-service ntp
    allow-service ospf
    no allow-service stun
	no shut
	exit
  int ge0/1
   description INTERNET-Traffic
   ip add 192.168.20.9/24
   tunnel-interface
    encapsulation ipsec
    color biz-internet
    allow-service bgp
    no allow-service dhcp
    allow-service dns
    allow-service icmp
    no allow-service sshd
    no allow-service netconf
    no allow-service ntp
    no allow-service ospf
    no allow-service stun
	no shut
	exit
   exit
  int ge0/2
   no description
   no ip add
   shutdown
   no tunnel-interface
   exit
  vpn 512
   name "Management VPN"
   interface eth0
    description eth0
    ip dhcp-client
    no shutdown
	commit
	end



CERTIFICATE AUTHORITY

1. Bootstrap configuration.

!@PKI-Server
conf t
 hostname PKI-SERVER
 enable secret pass
 service password-encryption
 no logging cons
 no ip domain lookup
 int g0/0
  ip add 10.69.255.5 255.255.255.248
  no shut
 ip route 0.0.0.0 0.0.0.0 10.69.255.6
 end
wr


2. Configure PKI Server
  - Enable HTTP
  - Generate Keys
  - Create PKI Server instance
	
!@PKI-Server
conf t
 ip http server
 !
 crypto key generate rsa label rivanpki modulus 2048 exportable
 !
 crypto pki server rivanpki
  database url flash:
  database level complete
  issuer-name cn=rootca.RIVANCORP.local
  hash sha256
  database archive pkcs12 password C1sc0123
  grant auto
  no shut
  exit
 end


3. Export the Root CA (rivanpki) and setup tftp server

!@PKI-Server
conf t
 crypto pki export rivanpki pem url flash:
 ! % The specified trustpoint is not enrolled (rivanpki).
 ! % Only export the CA certificate in PEM format.
 ! % Exporting CA certificate...
 ! Destination filename [rivanpki.ca]?
 ! 
 ! -> Enter
 !
 tftp-server flash:rivanpki.ca
 !
 crypto pki export rivanpki pem terminal
 ! -> Copy and store the CA
 end
wr
copy run start


EXAMPLE ROOT CA:

-----BEGIN CERTIFICATE-----
MIIDIDCCAgigAwIBAgIBATANBgkqhkiG9w0BAQsFADAhMR8wHQYDVQQDExZyb290
Y2EuUklWQU5DT1JQLmxvY2FsMB4XDTI2MDExODE5MDIxMloXDTI5MDExNzE5MDIx
MlowITEfMB0GA1UEAxMWcm9vdGNhLlJJVkFOQ09SUC5sb2NhbDCCASIwDQYJKoZI
hvcNAQEBBQADggEPADCCAQoCggEBANHmliLVoDJpoP/QYY9BYNoM5nYmqHTiWrcz
/edesixyK6l4a5e4sFVjFnUxf/+1ND4FIUE3zsDDJEtvmiziO+/ObM+e34uSvQKU
UoLIsUC96LQ+uwSrcWlA+0EYb9x+uHj1+sKKFE1n2paWcWHYxyy4Fdg0h/8vV4jJ
/yLvPrsI0Tp8HvZBMiNQmZihliNc9eiBToeWci3FkIbpoylOsih+Pt9gAjHisJpJ
2mATA0xcz5dt0DHM49zyIYUm4/F8i/NehDi98RanANgBlFVHHdIrcikAtqKq2usg
iTtxqfRDGfinEp7N2lQcflQmwkwrGrfpTC4FX5+QLtVRst//560CAwEAAaNjMGEw
DwYDVR0TAQH/BAUwAwEB/zAOBgNVHQ8BAf8EBAMCAYYwHwYDVR0jBBgwFoAUWTJM
3TFjBLb5mucfAOAjH+36gPQwHQYDVR0OBBYEFFkyTN0xYwS2+ZrnHwDgIx/t+oD0
MA0GCSqGSIb3DQEBCwUAA4IBAQA3f/bSd3vrB6u5F6nKMufwPoxVkRAnrTba1Ss+
jvnjJIZ0MbXnZdHaJyZM6Lof58HRE66Kg8sYeyd+VRHthSjR+rBGfqovUqm0mTeS
4NdwngebSbP/zrZKNsu7o/dazfJOdnNBrSqrWKoDliwXdtfrwWbei6/swX4WBVEF
EthIAgr2uvKKbKJleBk9j5spAz9JS9nAI2nJ0D/scFbpxcxHtjuNSypGxbvUA6E8
CihCAdhQxaGsO00S598LTCgtQepq3A0o39ER1u7L2Qa19lZXKr7jVVs7MTJlnXZo
dVb5NArbTAGGmpvcr8FdxjMN8LPBvD9a22GpnHUkZJxI1iah
-----END CERTIFICATE-----



SETUP CHAIN-OF-TRUST ON ALL SDWAN APPLIANCES

1. Install the Root CA on all SDWAN Appliances

!@ALL SDWAN Appliances
vshell
mkdir /home/admin/pkicerts
cd /home/admin/pkicerts
tftp -g -r rivanpki.ca 10.69.255.9
exit

	*If tftp does not work, print the CA on the terminal then create a file on all SDWAN linux shell with the contents of the Root CA.
		
		##################################
		### DO NOT COPY AND PASTE THIS ###
		##################################
		
	@ALL SDWAN Appliances
	vshell
	mkdir /home/admin/pkicerts
	cd /home/admin/pkicerts
	vim rivanpki.ca
		-> press ENTER
		-> press "i" for insert mode
		-> then, paste the root ca
		-> press "esc" button
		-> enter ":wq" which means write quit"
    exit
	

!@ALL SDWAN Appliances
request root-cert-chain install /home/admin/pkicerts/rivanpki.ca


2. Access vManage Web GUI

Username: admin
Password: C1sc0123

Navigate to "Administration" > "Settings"
Then, modify the following:
	Organization Name: RIVANCORP
	vBond: 172.16.10.3	Port: 12346
	Controller Certificate Authorization:
		Set CSR Properties:
			Domain Name: RIVANCORP.local
			Organizational Unit: RIVANCORP
			Organization: RIVANCORP
			City: Makati
			State: NCR
			Email: rivan@localhost.com
			2-Letter Country Code: PH
			Validity: 3 Years
	

3. Sign the CSR of all Controllers

!@Web GUI
configurations > certificate
	Generate CSR for vManage, vBond, and vSmart
	Then, copy the csr.


!@PKI-Server
crypto pki server rivanpki request pkcs10 terminal
! -> Paste the CSR
! -> Press ENTER
! -> Copy the granted certificate


4. Sign the CSR of all vEdges

!@vEdges
request csr upload /home/admin/pkicerts/requests.csr
vshell
cat /home/admin/pkicerts/requests.csr
! -> Copy the CSR


!@PKI-Server
crypto pki server rivanpki request pkcs10 terminal
! -> Paste the CSR
! -> Press ENTER
! -> Copy the granted certificate


!@vEdges
vshell
vim /home/admin/pkicerts/grant.ca
	-> press ENTER
	-> press "i" for insert mode
	-> then, paste the root ca
	-> press "esc" button
	-> enter ":wq" which means write quit"
exit
request certificate install /home/admin/pkicerts/grant.ca
show certificate serial

vEdge-LUZON# show certificate serial 
Chassis number: 61b94fbe-66e1-48a4-b5cf-9c45422c7ca7 serial number: 05
vEdge-LUZON# 

vEdge-VISAYAS# show certificate serial
Chassis number: 0c780aae-8c55-45f5-8696-451d2d331c2e serial number: 06
vEdge-VISAYAS# 

vEdge-MINDANAO# show certificate serial
Chassis number: 5f4be17b-8e6a-46ae-9467-35b26f5d569a serial number: 07
vEdge-MINDANAO# 



!@vManage, vBond
request vedge add chassis-num 5f4be17b-8e6a-46ae-9467-35b26f5d569a serial-num 07
request vedge add chassis-num 0c780aae-8c55-45f5-8696-451d2d331c2e serial-num 06
request vedge add chassis-num 61b94fbe-66e1-48a4-b5cf-9c45422c7ca7 serial-num 05



CONFIGURE BRANCH CORESWITCHES

!@CSW-LUZON
conf t
 hostname CSW-LUZON
 ip routing
 int lo0
  ip add 1.1.1.1 255.255.255.255
 int g0/0
  no sw
  ip add 172.16.1.2 255.255.255.252
  no shut
 int g0/1
  no sw
  ip add 10.1.1.2 255.255.255.252
  no shut
  end
wr


!@CSW-VISAYAS
conf t
 hostname CSW-VISAYAS
 ip routing
 int lo0
  ip add 2.2.2.2 255.255.255.255
 int g0/0
  no sw
  ip add 172.16.5.2 255.255.255.252
  no shut
 int g0/1
  no sw
  ip add 10.1.2.2 255.255.255.252
  no shut
  end
wr


!@CSW-MINDANAO
conf t
 ip routing
 hostname CSW-MINDANAO
 int lo0
  ip add 3.3.3.3 255.255.255.255
 int g0/0
  no sw
  ip add 172.16.9.2 255.255.255.252
  no shut
 int g0/1
  no sw
  ip add 10.1.3.2 255.255.255.252
  no shut
  end
wr


OSPF-Config

!@CSW-LUZON
conf t
router ospf 1
network 172.16.1.0 0.0.0.3 area 0
network 10.1.1.0 0.0.0.3 area 0
network 1.1.1.1 0.0.0.0 area 0
end
wr

!@CSW-VISAYAS
conf t
router ospf 1
network 172.16.5.0 0.0.0.3 area 0
network 10.1.2.0 0.0.0.3 area 0
network 1.1.1.1 0.0.0.0 area 0
end
wr

!@CSW-MINDANAO
conf t
router ospf 1
network 172.16.9.0 0.0.0.3 area 0
network 10.1.3.0 0.0.0.3 area 0
network 1.1.1.1 0.0.0.0 area 0
end
wr
